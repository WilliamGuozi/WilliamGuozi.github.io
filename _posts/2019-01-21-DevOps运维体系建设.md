# DevOps：运维体系建设

## 简介  
> 运维体系的建设的目的在于方便运维工作，旨在实现自动化、规范化、流程化，提高运维效率，打造一个安全、可靠、高效、可追踪、可回溯的运维环境，高可用、高并发、具备自我容错、自我修复、故障快速定位的生产环境运维生态环境。本篇文章将从三个方面来讨论运维体系的建设，账号权限管理、发布流程CI/CD、系统监控预警，文中可能多有理解不透、涉及不到甚至错误之处，希望有见解的小伙伴留言交流。

## 基于OpenLDAP的统一账号管理
1.  LDAP(Lightweight Directory Access Protocol)轻量级目录访问协议，是一个开放的，中立的，工业标准的应用协议，通过IP协议提供访问控制和维护分布式信息的目录信息。  

2. OpenLDAP是轻型目录访问协议 LDAP 的自由和开源的实现，在其OpenLDAP许可证下发行，并已经被包含在众多流行的Linux发行版中。 OpenLDAP的一个常用用途是单点登录，用户可以在多个服务中使用同一个密码，通常用于公司内部网站的登录中（这样他们可以在公司计算机上登录一次，便可以自动在公司内部网上登录）。

3. 在运维工作中，主要是用其单点登录、用户分组、配合业务支撑系统实现权限管理和准入控制。最重要的是，目前大部分系统均支持LDAP，公司中使用的Gitlab、Jenkins、Jira、Jumpserver、Docker harbor、Zabbix、OpenVPN、甚至包括nginx均可实现和LDAP的对接。

![img-w500](/images/201903061750.png) 

## 自动化运维CI/CD
1. 该自动化持续集成体系可根据不同的公司规模作出调整，但对于大公司，整个运维生态建立的越完整，对于工作效率和管理的方便程度，就起到了至关重要的作用。

2. 所谓运维开发，我的理解是所有的工作内容也是通过版本管理工具来管理，所有的更改和操作均可通过记录查询以及通过版本回退。

3. 就云上建立新主机为例，可以通过一个清单，包含所需要建立机器的区域、CPU、内存、磁盘、主机名、使用的镜像等，提交至gitlab，gitlab自动触发Jenkins构建，调用云API创建主机，同时进行初始化，安装监控客户端，将监控指标推送到监控系统，同时Jenkins将该主机的信息添加到Jumpserver中，方便管理，从而实现整个闭环。

4. 就构建部署来讲，Jenkins有三个环境的Job，分组呈现，不同分组的人员可看到不同的Job，从而实现权限的控制，对于开发环境的Job来自于Gitlab仓库中dev分支的代码，测试环境的代码来自于master分支，线上环境的Job来自于master上分支上打过tag的代码，开发测试无法看到线上环境的Job，当需要升级时，开发人员将tag交给运维，运维升级完成验证同时通知开发。

5. 灰度发布，灰度发布有赖于系统架构，原则上需要系统高可用、负载均衡、方便横向扩展，比如，公司采用淘宝网开发的Dubbo架构，可将各功能拆解为单个模块，模块可多节点部署，模块启动注册到同一管理平台zookeeper，成为生产者或消费者，业务实时查询zookeeper，如此便可一台一台发布，实现发布过程的业务不中断，从而实现灰度发布，前端H5页面发布至nginx上，nginx处在lb后端，可作多节点，实现高可用和负载均衡，从而保证业务的文档性。

6. 对于Jira工单系统，运维人员也可以使用，可用做知识共享平台，将平常的工作记录到该平台上，杜绝同一问题需要多次处理，同时又可以将一个大问题，分解成许多的可操作的小问题，逐个攻破，再者，可以通过这个平台锻炼文档的书写能力，如何将一个问题说的大家都能够理解。

![img-w500](/images/201903071740.png) 

## 系统监控预警

1. 将所有主机加入监控，时刻掌握他们的状态，一旦有指标不正常，触发器触发告警，可通过微信、钉钉、邮件方式收到告警，详细有效的监控是保证系统正常运行不可少的东西，防患于未然。

2. 日志的收集收集和监控也是很有必要的，当集群环境壮大之后，某一个模块可能会部署多个节点，再登录到机器上查看日志就变得很困难，此时，可以将日志收集到ELK等平台上，按模块分类。还有一个原因就是有些故障只能从日志中定位，比如Java程序，程序仍在运行，但是报错，服务不可用，这个时候，监控日志中的错误信息，实时报警，就能及时定位故障，加快问题处理的数据

3. 除此之外，还有一个重要的方面，就是备份，数据库的备份，一些配置文件的备份可在灾难爆发时，让你不至于走头无路，使用gitlab实时备份一些数据是一种很有效的方式。

![img-w500](/images/201903071701.png) 


## 参考文档  
+ 搞懂OpenLDAP：<https://segmentfault.com/a/1190000014683418>
+ VisualParadigm: <https://online.visual-paradigm.com>