# DevOps：运维体系建设

## 简介  
> 运维体系的建设旨在自动化，方便运维工作，提高运维效率，打造一个安全、高效、可追踪、可回溯、的运维环境，高可用、高并发、具备自我容错、自我修复、故障快速定位的生产环境。本篇文章将从三个方面来讨论运维体系的建设，账号权限管理、发布流程CI/CD、线上环境监控预警，文中可能多有理解不透、涉及不到甚至错误之处，希望有见解的小伙伴留言交流。

## 基于OpenLDAP的统一账号管理
LDAP(Lightweight Directory Access Protocol)轻量级目录访问协议，是一个开放的，中立的，工业标准的应用协议，通过IP协议提供访问控制和维护分布式信息的目录信息。OpenLDAP是轻型目录访问协议（Lightweight Directory Access Protocol，LDAP）的自由和开源的实现，在其OpenLDAP许可证下发行，并已经被包含在众多流行的Linux发行版中。OpenLDAP的一个常用用途是单点登录，用户可以在多个服务中使用同一个密码，通常用于公司内部网站的登录中（这样他们可以在公司计算机上登录一次，便可以自动在公司内部网上登录）。其作用主要在于能够实现账户名和密码的统一管理，避免每个系统都需要一个账号密码的冗杂和重复性工作，极大的提升了工作效率和管理的方便程度，可谓管理工作中必不可少的工作。而且，目前大部分系统都支持和OpenLDAP对接，目前公司中使用的Gitlab、Jenkins、Jira、Jumpserver、Docker harbor、Zabbix、OpenVPN、甚至包括nginx均可实现和LDAP的对接。能够实现对公司员工的

## 自动化CI/CD

## 线上环境监控预警
数据备份




## SSL证书的工作原理

> 证书主要作用是在SSL握手中，我们来看一下SSL的握手过程

1. 客户端提交https请求
2. 服务器响应客户，并把证书公钥发给客户端
3. 客户端验证证书公钥的有效性
4. 有效后，会生成一个会话密钥
5. 用证书公钥加密这个会话密钥后，发送给服务器
6. 服务器收到公钥加密的会话密钥后，用私钥解密，回去会话密钥
7. 客户端与服务器双方利用这个会话密钥加密要传输的数据进行通信
![img-w500](/images/201901211728.png) 

## GoDaddy 证书制作过程  

### 制作CSR证书签署请求文件
> 生成证书签署请求CSR(Certificate Signing Request)文件，本文以glinux.top域名为例，需要填写的信息中，请注意Common Name，应为泛域名地址，如: *.glinux.top  

```openssl req -new -newkey rsa:2048 -nodes -keyout glinux.top.key -out glinux.top.csr```

```
Generating a 2048 bit RSA private key
.......................+++
...................+++
writing new private key to 'glinux.top.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:CN
State or Province Name (full name) []:ZhejiangSheng
Locality Name (eg, city) [Default City]:Hangzhou
Organization Name (eg, company) [Default Company Ltd]:glinux
Organizational Unit Name (eg, section) []:DevOps
Common Name (eg, your name or your server's hostname) []:*.glinux.top
Email Address []:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
```
> 生成两个文件，glinux.top.csr为证书签署请求，glinux.top.key为解密使用的私钥  

![img-w500](/images/201901211759.png) 

> 将证书签署请求内容输入到该网站<https://www.ssldun.com/tools/csr-decoder.php#results>进行解码，如下图。

![img-w500](/images/201901211811.png) 

### CA签署请求
> 打开GoDaddy中所购买的SSL证书，填写相关内容，验证域名持有者信息，一般有两种方式，通过邮件或者在DNS添加解析记录，等待证书的签发。

### 证书的安装
> 待证书签发完成，找到证书下载页，选择对应的web服务类型，如果不存在，请选择其他，此处以nginx web服务类型为主

![img-w500](/images/201801211858.png) 

> 下载完成，将解压出的文件合并成一个文件，并命名为crt格式，即为证书文件  

```cat fd72a4fa7c1de0e3.crt gd_bundle-g2-g1.crt > glinux.top.crt```

![img-w500](/images/201901211912.png) 

> 更新配置文件以使用 SSL 证书  

```
    server {
        listen       80 default_server;
        server_name  example.htrader.cn;
        return 301 https://$host$request_uri;
    }

    server {
        listen       443 ssl http2 default_server;
        server_name  example.glinux.top;
        root         /usr/share/nginx/html;

        ssl_certificate "/etc/nginx/conf.d/glinux.top.crt";
        ssl_certificate_key "/etc/nginx/conf.d/glinux.top.key";
        index index.php index.html index.htm
   }
```

## 参考文档  
+ 轻型目录访问协议：<https://zh.wikipedia.org/wiki/%E8%BD%BB%E5%9E%8B%E7%9B%AE%E5%BD%95%E8%AE%BF%E9%97%AE%E5%8D%8F%E8%AE%AE>
+ 搞懂OpenLDAP：<https://segmentfault.com/a/1190000014683418>